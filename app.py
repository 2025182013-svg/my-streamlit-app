import streamlit as st
import requests
from collections import Counter
import time

st.set_page_config(
    page_title="ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?",
    page_icon="ğŸ¬",
    layout="wide",
)

# ======================
# Sidebar
# ======================
st.sidebar.title("ğŸ”‘ TMDB API ì„¤ì •")
api_key = st.sidebar.text_input("TMDB API Key", type="password")

# ======================
# Session State
# ======================
if "step" not in st.session_state:
    st.session_state.step = 0

if "answers" not in st.session_state:
    st.session_state.answers = {}

# ======================
# ì¥ë¥´ ë§¤í•‘
# ======================
choice_to_genre = {
    "í˜¼ì ì¡°ìš©íˆ, ê°ì •ì„  ì°í•œ ì˜í™” ë³´ë©´ì„œ í•˜ë£¨ ì •ë¦¬": "ë“œë¼ë§ˆ",
    "ì—ë„ˆì§€ ë‚¨ì•„ë. ë­ë¼ë„ í•´ì•¼ ì§ì„±ì— í’€ë¦¼": "ì•¡ì…˜",
    "í˜„ì‹¤ íƒˆì¶œ. ë‹¤ë¥¸ ì„¸ê³„ë¡œ ê°€ê³  ì‹¶ë‹¤": "íŒíƒ€ì§€",
    "ë‡Œ ë¹¼ê³  ì›ƒì„ ìˆ˜ ìˆëŠ” ê²Œ ìµœê³ ": "ì½”ë¯¸ë””",

    "ê³ ìƒ ëâ€¦ ì—¬ìš´ì´ ë‚¨ëŠ” ê¸°ë¶„": "ë“œë¼ë§ˆ",
    "í•´ë°©ê° í­ë°œğŸ”¥ ì˜¤ëŠ˜ì€ ë°¤ìƒˆë„ ë¨": "ì•¡ì…˜",
    "ì´ì œ ë‹¤ìŒ ì±•í„°ë¡œ ë„˜ì–´ê°„ ëŠë‚Œ": "SF",
    "ë°ˆÂ·ë¦´ìŠ¤Â·ì›ƒê¸´ ê±° ë³¼ ìƒê°ë¿": "ì½”ë¯¸ë””",

    "ê°ì„± ìˆ™ì†Œ + ì‚¬ì§„ + ì¹´í˜": "ë¡œë§¨ìŠ¤",
    "ëª¸ ì“°ëŠ” ì¼ì • í’€ì½”ìŠ¤": "ì•¡ì…˜",
    "ì´êµ­ì ì´ê±°ë‚˜ ë¹„í˜„ì‹¤ì ì¸ ì¥ì†Œ": "íŒíƒ€ì§€",
    "ê³„íš ì—†ì´ ê°€ì„œ ì›ƒê¸´ ì¼ ìƒê¸°ëŠ” ì—¬í–‰": "ì½”ë¯¸ë””",

    "ìš”ì¦˜ ê°ì • ê¸°ë³µì´ë‚˜ ì¸ê°„ê´€ê³„": "ë“œë¼ë§ˆ",
    "ì•ìœ¼ë¡œ ë­˜ í• ì§€, ëª©í‘œ": "ì•¡ì…˜",
    "ë¯¸ë˜Â·ìš°ì£¼Â·ë§Œì•½ì— ì´ëŸ° ìƒìƒ": "SF",
    "ì•„ë¬´ ìƒê° ì—†ì´ ì‚¬ëŠ” ì¤‘ ã…‹ã…‹": "ì½”ë¯¸ë””",

    "ìŠ¤í† ë¦¬ë‘ ê°ì • ëª°ì…": "ë“œë¼ë§ˆ",
    "ì†ë„ê°, ê¸´ì¥ê°, ì•¡ì…˜": "ì•¡ì…˜",
    "ì„¸ê³„ê´€ì´ ì‹ ë°•í•œ ê²Œ ì¤‘ìš”": "SF",
    "ì›ƒê¸°ë©´ ì¥ë•¡": "ì½”ë¯¸ë””",
}

genre_id_map = {
    "ì•¡ì…˜": 28,
    "ì½”ë¯¸ë””": 35,
    "ë“œë¼ë§ˆ": 18,
    "SF": 878,
    "ë¡œë§¨ìŠ¤": 10749,
    "íŒíƒ€ì§€": 14,
}

genre_reason = {
    "ì•¡ì…˜": "ê°€ë§Œíˆ ìˆìœ¼ë©´ ì¢€ì´ ì‘¤ì‹œëŠ” íƒ€ì…! ì‹œì›í•œ ì „ê°œê°€ ì˜ ë§ì•„ìš”.",
    "ì½”ë¯¸ë””": "ì˜í™”ëŠ” ì¦ê±°ì›Œì•¼ì£  ğŸ˜† ì›ƒìŒ í¬ì¸íŠ¸ê°€ ì¤‘ìš”í•œ ì·¨í–¥ì´ì—ìš”.",
    "ë“œë¼ë§ˆ": "ì´ì•¼ê¸°ì™€ ê°ì •ì„ ì„ ì¤‘ìš”í•˜ê²Œ ë³´ëŠ” ì„¬ì„¸í•œ íƒ€ì…ì´ì—ìš”.",
    "SF": "í˜„ì‹¤ë³´ë‹¤ ìƒìƒ! ìƒˆë¡œìš´ ì„¸ê³„ê´€ì— ëŒë¦¬ëŠ” ì·¨í–¥ì´ì—ìš”.",
    "ë¡œë§¨ìŠ¤": "ì‚¬ëŒ ì‚¬ì´ì˜ ê°ì • íë¦„ì— ê³µê°í•˜ëŠ” íƒ€ì…ì´ì—ìš”.",
    "íŒíƒ€ì§€": "í˜„ì‹¤ íƒˆì¶œìš© ì˜í™”ê°€ ë”± ë§ëŠ” ìŠ¤íƒ€ì¼ì´ì—ìš”.",
}

# ======================
# ì§ˆë¬¸ (ì¬ë¯¸ + ê°€ë…ì„± ê°•í™”)
# ======================
questions = [
    (
        "í•˜ë£¨ ë! ì§€ê¸ˆ ê°€ì¥ í•˜ê³  ì‹¶ì€ ê±´?",
        [
            "í˜¼ì ì¡°ìš©íˆ, ê°ì •ì„  ì°í•œ ì˜í™” ë³´ë©´ì„œ í•˜ë£¨ ì •ë¦¬",
            "ì—ë„ˆì§€ ë‚¨ì•„ë. ë­ë¼ë„ í•´ì•¼ ì§ì„±ì— í’€ë¦¼",
            "í˜„ì‹¤ íƒˆì¶œ. ë‹¤ë¥¸ ì„¸ê³„ë¡œ ê°€ê³  ì‹¶ë‹¤",
            "ë‡Œ ë¹¼ê³  ì›ƒì„ ìˆ˜ ìˆëŠ” ê²Œ ìµœê³ ",
        ],
    ),
    (
        "ì‹œí—˜ ëë‚œ ì§í›„ ë‹¹ì‹  ìƒíƒœëŠ”?",
        [
            "ê³ ìƒ ëâ€¦ ì—¬ìš´ì´ ë‚¨ëŠ” ê¸°ë¶„",
            "í•´ë°©ê° í­ë°œğŸ”¥ ì˜¤ëŠ˜ì€ ë°¤ìƒˆë„ ë¨",
            "ì´ì œ ë‹¤ìŒ ì±•í„°ë¡œ ë„˜ì–´ê°„ ëŠë‚Œ",
            "ë°ˆÂ·ë¦´ìŠ¤Â·ì›ƒê¸´ ê±° ë³¼ ìƒê°ë¿",
        ],
    ),
    (
        "ì—¬í–‰ ê°„ë‹¤ë©´ ë‹¹ì‹  ìŠ¤íƒ€ì¼ì€?",
        [
            "ê°ì„± ìˆ™ì†Œ + ì‚¬ì§„ + ì¹´í˜",
            "ëª¸ ì“°ëŠ” ì¼ì • í’€ì½”ìŠ¤",
            "ì´êµ­ì ì´ê±°ë‚˜ ë¹„í˜„ì‹¤ì ì¸ ì¥ì†Œ",
            "ê³„íš ì—†ì´ ê°€ì„œ ì›ƒê¸´ ì¼ ìƒê¸°ëŠ” ì—¬í–‰",
        ],
    ),
    (
        "ìš”ì¦˜ ê°€ì¥ ë§ì´ ë“œëŠ” ìƒê°ì€?",
        [
            "ìš”ì¦˜ ê°ì • ê¸°ë³µì´ë‚˜ ì¸ê°„ê´€ê³„",
            "ì•ìœ¼ë¡œ ë­˜ í• ì§€, ëª©í‘œ",
            "ë¯¸ë˜Â·ìš°ì£¼Â·ë§Œì•½ì— ì´ëŸ° ìƒìƒ",
            "ì•„ë¬´ ìƒê° ì—†ì´ ì‚¬ëŠ” ì¤‘ ã…‹ã…‹",
        ],
    ),
    (
        "ì˜í™” ë³¼ ë•Œ ê°€ì¥ ì¤‘ìš”í•œ ê±´?",
        [
            "ìŠ¤í† ë¦¬ë‘ ê°ì • ëª°ì…",
            "ì†ë„ê°, ê¸´ì¥ê°, ì•¡ì…˜",
            "ì„¸ê³„ê´€ì´ ì‹ ë°•í•œ ê²Œ ì¤‘ìš”",
            "ì›ƒê¸°ë©´ ì¥ë•¡",
        ],
    ),
]

# ======================
# ì œëª©
# ======================
st.markdown("## ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?")
st.markdown(
    "<p style='font-size:18px; color:gray;'>ì§ˆë¬¸ì— ë‹µí•˜ë©´ ì·¨í–¥ ì €ê²© ì˜í™”ê°€ ë‚˜ì™€ìš” ğŸ¿</p>",
    unsafe_allow_html=True,
)
st.divider()

# ======================
# ì§ˆë¬¸ í™”ë©´ (ì—¬ë°± + ê¸€ì”¨ í¬ê²Œ)
# ======================
if st.session_state.step < len(questions):
    q, opts = questions[st.session_state.step]

    st.markdown(f"### Q{st.session_state.step + 1}")
    st.markdown(
        f"<p style='font-size:22px; font-weight:600;'>{q}</p>",
        unsafe_allow_html=True,
    )
    st.write("")  # ì—¬ë°±

    answer = st.radio("", opts, index=None)

    st.write("")
    if answer and st.button("ë‹¤ìŒ â¡ï¸"):
        st.session_state.answers[st.session_state.step] = answer
        st.session_state.step += 1
        st.rerun()

# ======================
# ë¡œë”©
# ======================
elif st.session_state.step == len(questions):
    with st.spinner("ğŸ¥ ì·¨í–¥ ë¶„ì„ ì¤‘..."):
        time.sleep(2)
        st.session_state.step += 1
        st.rerun()

# ======================
# ê²°ê³¼ í™”ë©´
# ======================
else:
    if not api_key:
        st.warning("TMDB API Keyë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    else:
        genres = [choice_to_genre[a] for a in st.session_state.answers.values()]
        final_genre = Counter(genres).most_common(1)[0][0]

        st.markdown(
            f"## ğŸ¯ ë‹¹ì‹ ì—ê²Œ ë”±ì¸ ì¥ë¥´ëŠ” **{final_genre}**!"
        )
        st.markdown(
            f"<p style='font-size:18px;'>{genre_reason[final_genre]}</p>",
            unsafe_allow_html=True,
        )

        url = (
            f"https://api.themoviedb.org/3/discover/movie"
            f"?api_key={api_key}"
            f"&with_genres={genre_id_map[final_genre]}"
            f"&language=ko-KR"
            f"&sort_by=vote_average.desc"
            f"&vote_count.gte=300"
        )

        movies = requests.get(url).json().get("results", [])
        movies = [m for m in movies if m.get("poster_path")][:6]

        st.markdown("### â­ í‰ì  ë†’ì€ ì¶”ì²œ ì˜í™”")

        cols = st.columns(3)
        for i, movie in enumerate(movies):
            with cols[i % 3]:
                st.image(
                    "https://image.tmdb.org/t/p/w500" + movie["poster_path"],
                    width=220,
                )
                st.markdown(f"**{movie['title']}**")
                st.write(f"â­ {movie['vote_average']}")

                with st.expander("ì¤„ê±°ë¦¬ ë³´ê¸°"):
                    st.write(movie["overview"] or "ì¤„ê±°ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")

        st.divider()
        if st.button("ğŸ”„ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°"):
            st.session_state.clear()
            st.rerun()
